<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Athena ‚Äî Control Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: #0D1117;
            color: #C9D1D9;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            display: flex;
            align-items: center;
            padding: 12px 24px;
            background: #161B22;
            border-bottom: 1px solid #21262D;
        }

        .brand {
            font-size: 20px;
            font-weight: 800;
            color: #58A6FF;
            letter-spacing: 2px;
        }

        .stats {
            margin-left: auto;
            display: flex;
            gap: 24px;
        }

        .stat {
            text-align: center;
        }

        .stat-val {
            font-size: 20px;
            font-weight: 700;
        }

        .stat-lbl {
            font-size: 10px;
            color: #8B949E;
            text-transform: uppercase;
        }

        .main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        #map {
            flex: 1;
            background: #161B22;
        }

        .panel {
            width: 380px;
            background: #161B22;
            border-left: 1px solid #21262D;
            display: flex;
            flex-direction: column;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #21262D;
        }

        .tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            color: #8B949E;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
        }

        .tab.active {
            color: #E6EDF3;
            border-bottom-color: #58A6FF;
        }

        .tab span {
            background: #21262D;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 6px;
        }

        .list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .card {
            background: #0D1117;
            border: 1px solid #21262D;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
        }

        .card-title {
            font-size: 11px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
            margin-bottom: 6px;
        }

        .card-meta {
            font-size: 11px;
            color: #8B949E;
            margin-top: 4px;
        }

        .card-main {
            font-size: 14px;
            font-weight: 600;
            color: #E6EDF3;
            margin: 4px 0;
        }

        .btn-clear {
            background: #238636;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
            float: right;
            font-weight: 600;
        }

        .btn-clear:hover {
            background: #2EA043;
        }

        .ws-badge {
            font-size: 10px;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .popup-custom {
            background: #161B22;
            color: #C9D1D9;
            border-radius: 6px;
            padding: 8px;
            border: 1px solid #30363D;
            width: 160px;
        }

        .leaflet-popup-content-wrapper,
        .leaflet-popup-tip {
            background: #161B22;
            color: #C9D1D9;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }

            100% {
                opacity: 1;
            }
        }

        @keyframes vehiclePulse {

            0%,
            100% {
                opacity: 0.6;
                transform: scale(1);
            }

            50% {
                opacity: 0.1;
                transform: scale(1.6);
            }
        }
    </style>
</head>

<body>

    <header>
        <div style="display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 24px;">üèõÔ∏è</span>
            <div>
                <div class="brand">ATHENA</div>
                <div style="font-size: 11px; color: #8B949E;">Control Dashboard</div>
            </div>
        </div>
        <div class="stats">
            <div class="stat">
                <div class="stat-val" style="color: #F85149" id="s-inc">0</div>
                <div class="stat-lbl">Incidents</div>
            </div>
            <div class="stat">
                <div class="stat-val" style="color: #FF7B72" id="s-crit">0</div>
                <div class="stat-lbl">Critical</div>
            </div>
            <div class="stat">
                <div class="stat-val" style="color: #58A6FF" id="s-int">0</div>
                <div class="stat-lbl">Intercept</div>
            </div>
            <div style="display: flex; align-items: center;">
                <div class="ws-badge" id="ws-badge"
                    style="color: #E3B341; border-color: #E3B34144; background: #E3B34111;">
                    <div class="dot" style="background: #E3B341"></div> CONNECTING
                </div>
            </div>
        </div>
    </header>

    <div class="main">
        <div id="map"></div>
        <div class="panel">
            <div class="tabs">
                <button class="tab active" onclick="setTab('incidents')">üö¶ Incidents <span id="t-inc">0</span></button>
                <button class="tab" onclick="setTab('critical')">üö® Critical <span id="t-crit">0</span></button>
                <button class="tab" onclick="setTab('intercept')">‚ö° Intercept <span id="t-int">0</span></button>
            </div>
            <div class="list" id="list"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API = location.hostname === '' ? 'http://localhost:8000' : `${location.protocol}//${location.hostname}:8000`;

        // State
        const state = {
            incidents: [],
            criticalAlerts: [],
            interceptAlerts: [],
            officers: [],
            tab: 'incidents',
            markers: {}
        };

        // Bengaluru city center & bounds
        const BENGALURU_CENTER = [12.9716, 77.5946];
        const BENGALURU_ZOOM = 13;
        const BENGALURU_BOUNDS = L.latLngBounds(
            L.latLng(12.7342, 77.3791),
            L.latLng(13.1726, 77.8415)
        );

        // Demo officers ‚Äî used if backend returns no officers
        const DEMO_OFFICERS = [
            { officer_id: 'KA-BLR-001', latitude: 12.9719, longitude: 77.5937, heading: 45, speed_mps: 0, on_duty: true, last_updated: new Date().toISOString() },
            { officer_id: 'KA-BLR-002', latitude: 12.9352, longitude: 77.6245, heading: 135, speed_mps: 4.2, on_duty: true, last_updated: new Date().toISOString() },
            { officer_id: 'KA-BLR-003', latitude: 13.0079, longitude: 77.5643, heading: 270, speed_mps: 8.3, on_duty: true, last_updated: new Date().toISOString() },
            { officer_id: 'KA-BLR-004', latitude: 12.9592, longitude: 77.6416, heading: 0, speed_mps: 0, on_duty: true, last_updated: new Date().toISOString() },
            { officer_id: 'KA-BLR-005', latitude: 12.9698, longitude: 77.7500, heading: 90, speed_mps: 5.6, on_duty: false, last_updated: new Date().toISOString() },
            { officer_id: 'KA-BLR-006', latitude: 12.9279, longitude: 77.5003, heading: 200, speed_mps: 2.1, on_duty: true, last_updated: new Date().toISOString() },
        ];

        // Demo tracked vehicles
        const DEMO_TRACKED_VEHICLES = [
            { id: 'tv-1', plate: 'KA 05 MN 1234', make: 'Toyota', model: 'Innova', caseType: 'STOLEN', latitude: 12.9658, longitude: 77.6197, color: '#E3B341' },
            { id: 'tv-2', plate: 'KA 01 AB 9876', make: 'Honda', model: 'City', caseType: 'HIT_AND_RUN', latitude: 12.9890, longitude: 77.5720, color: '#FF7B72' },
            { id: 'tv-3', plate: 'KA 19 CD 5555', make: 'Maruti', model: 'Swift', caseType: 'KIDNAPPING', latitude: 12.9445, longitude: 77.6890, color: '#F85149' },
            { id: 'tv-4', plate: 'KA 03 EF 7777', make: 'Hyundai', model: 'Creta', caseType: 'STOLEN', latitude: 13.0200, longitude: 77.6100, color: '#E3B341' },
        ];

        // Colors
        const COLORS = {
            STALLED_VEHICLE: '#F0883E',
            BREAKDOWN: '#E3B341',
            ACCIDENT: '#F85149',
            PEDESTRIAN_VIOLATION: '#BC8CFF',
            KIDNAPPING: '#F85149',
            HIT_AND_RUN: '#FF7B72',
            STOLEN: '#E3B341',
            DEFAULT: '#58A6FF'
        };

        // Init Map ‚Äî Bengaluru only
        const map = L.map('map', { zoomControl: true }).setView(BENGALURU_CENTER, BENGALURU_ZOOM);
        map.setMaxBounds(BENGALURU_BOUNDS);
        map.setMinZoom(10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap | Bengaluru Police Command',
            maxZoom: 19
        }).addTo(map);

        // City label
        const cityLabel = L.control({ position: 'topcenter' });
        const cityDiv = document.createElement('div');
        cityDiv.innerHTML = 'üèôÔ∏è Bengaluru City ‚Äî Live Surveillance';
        cityDiv.style.cssText = 'background:#161B22CC;border:1px solid #30363D;border-radius:20px;padding:4px 14px;font-size:11px;color:#8B949E;pointer-events:none;margin-top:8px;font-family:Inter,sans-serif';
        document.getElementById('map').appendChild(cityDiv);
        cityDiv.style.position = 'absolute';
        cityDiv.style.top = '12px';
        cityDiv.style.left = '50%';
        cityDiv.style.transform = 'translateX(-50%)';
        cityDiv.style.zIndex = '999';

        function makeIcon(color, size = 14) {
            return L.divIcon({
                className: '',
                html: `<div style="width:${size}px;height:${size}px;background:${color};border:2px solid #fff;border-radius:50%;box-shadow:0 0 10px ${color}"></div>`,
                iconSize: [size, size],
                iconAnchor: [size / 2, size / 2]
            });
        }

        function makeOfficerIcon(onDuty, heading) {
            const color = onDuty ? '#58A6FF' : '#8B949E';
            return L.divIcon({
                className: '',
                html: `
                  <div style="position:relative;width:32px;height:32px;">
                    <div style="position:absolute;inset:0;background:${color};border:2px solid #fff;border-radius:50%;box-shadow:0 0 12px ${color}99;display:flex;align-items:center;justify-content:center;font-size:14px">üöî</div>
                    <div style="position:absolute;top:-6px;left:50%;width:0;height:0;
                      border-left:5px solid transparent;border-right:5px solid transparent;border-bottom:8px solid ${color};
                      transform:translateX(-50%) rotate(${heading}deg);transform-origin:50% 100%;"></div>
                  </div>`,
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });
        }

        function makeVehicleIcon(color) {
            return L.divIcon({
                className: '',
                html: `
                  <div style="position:relative;width:36px;height:36px;">
                    <div style="position:absolute;inset:4px;background:#0D1117;border:2px solid ${color};border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:15px;box-shadow:0 0 14px ${color}99">üöó</div>
                    <div style="position:absolute;inset:-2px;border:2px solid ${color};border-radius:10px;animation:vehiclePulse 1.5s ease-in-out infinite"></div>
                  </div>`,
                iconSize: [36, 36],
                iconAnchor: [18, 18]
            });
        }

        // Render logic
        function updateUI() {
            const activeInc = state.incidents.filter(i => i.status === 'ACTIVE');
            document.getElementById('s-inc').innerText = activeInc.length;
            document.getElementById('t-inc').innerText = activeInc.length;
            document.getElementById('s-crit').innerText = state.criticalAlerts.length;
            document.getElementById('t-crit').innerText = state.criticalAlerts.length;
            document.getElementById('s-int').innerText = state.interceptAlerts.length;
            document.getElementById('t-int').innerText = state.interceptAlerts.length;

            renderList();
            renderMarkers();
        }

        function setTab(name) {
            state.tab = name;
            document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
            renderList();
        }

        function timeStr(iso) {
            if (!iso) return '';
            return new Date(iso).toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        function clearIncident(id) {
            fetch(`${API}/api/v1/incidents/${id}/clear`, { method: 'POST' })
                .then(() => {
                    const inc = state.incidents.find(i => i.id === id);
                    if (inc) { inc.status = 'CLEARED'; updateUI(); }
                });
        }

        function renderList() {
            const list = document.getElementById('list');
            list.innerHTML = '';

            if (state.tab === 'incidents') {
                state.incidents.forEach(inc => {
                    const c = COLORS[inc.type] || COLORS.DEFAULT;
                    const isActive = inc.status === 'ACTIVE';
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.borderColor = isActive ? c + '66' : '#21262D';
                    card.innerHTML = `
            ${isActive ? `<button class="btn-clear" onclick="clearIncident('${inc.id}')">CLEAR</button>` : ''}
            <div class="card-title" style="color:${c}; background:${c}22">${inc.type.replace(/_/g, ' ')}</div>
            <div class="card-meta">üìç ${inc.latitude.toFixed(4)}, ${inc.longitude.toFixed(4)}</div>
            <div class="card-meta">üì∑ ${inc.camera_id} ¬∑ ${(inc.confidence * 100).toFixed(0)}% conf</div>
            <div class="card-meta" style="color:${isActive ? '#3FB950' : '#8B949E'}; margin-top:8px; display:flex; justify-content:space-between">
              <span>${inc.status}</span>
              <span>${timeStr(inc.detected_at)}</span>
            </div>
          `;
                    list.appendChild(card);
                });
            } else if (state.tab === 'critical') {
                state.criticalAlerts.forEach(c => {
                    const col = COLORS[c.case_type] || COLORS.DEFAULT;
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.borderColor = col + '66';
                    card.innerHTML = `
            <div style="float:right; font-size:10px; color:${col}; background:${col}22; padding:2px 6px; border-radius:10px;">${c.priority}</div>
            <div class="card-title" style="color:${col}; background:${col}22">üö® ${c.case_type.replace(/_/g, ' ')}</div>
            <div class="card-main">${c.license_plate}</div>
            <div class="card-meta">${c.make} ${c.model}</div>
            <div class="card-meta">Case: ${c.case_number}</div>
            <div class="card-meta" style="margin-top:8px">${timeStr(c.timestamp)}</div>
          `;
                    list.appendChild(card);
                });
            } else if (state.tab === 'intercept') {
                state.interceptAlerts.forEach(a => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.borderColor = '#58A6FF66';
                    card.innerHTML = `
            <div style="float:right; text-align:right;">
              <div style="color:#58A6FF; font-size:16px; font-weight:700">${Math.round(a.distance_m)}m</div>
              <div class="card-meta">${a.direction} ¬∑ ETA ${Math.round(a.estimated_intercept_s)}s</div>
            </div>
            <div class="card-title" style="color:#58A6FF; background:#58A6FF22">‚ö° INTERCEPT</div>
            <div class="card-main">${a.vehicle_plate}</div>
            <div class="card-meta">${a.vehicle_make} ${a.vehicle_model}</div>
            <div class="card-meta" style="color:#E3B341; margin-top:4px">${a.violation_type.replace(/_/g, ' ')}</div>
          `;
                    list.appendChild(card);
                });
            }
        }

        function renderMarkers() {
            // Clear all
            Object.values(state.markers).forEach(m => map.removeLayer(m));
            state.markers = {};

            // Tracked vehicles (from critical alerts or demo data)
            const trackedVehicles = state.criticalAlerts.length > 0
                ? state.criticalAlerts.map(a => ({
                    id: 'crit-' + a.vehicle_id,
                    plate: a.license_plate, make: a.make, model: a.model,
                    caseType: a.case_type,
                    latitude: a.location.latitude, longitude: a.location.longitude,
                    color: COLORS[a.case_type] || COLORS.DEFAULT
                }))
                : DEMO_TRACKED_VEHICLES;

            trackedVehicles.forEach(v => {
                const m = L.marker([v.latitude, v.longitude], { icon: makeVehicleIcon(v.color) })
                    .bindPopup(`
                      <div style="background:#161B22;color:#C9D1D9;padding:10px;border-radius:6px;min-width:200px">
                        <b style="color:${v.color}">üöó TRACKED VEHICLE</b>
                        <div style="font-size:14px;font-weight:700;color:#E6EDF3;margin-top:4px">${v.plate}</div>
                        <div style="font-size:11px;color:#8B949E">${v.make} ${v.model}</div>
                        <div style="margin-top:4px"><span style="color:${v.color};background:${v.color}22;padding:2px 6px;border-radius:8px;font-size:11px">${v.caseType.replace(/_/g, ' ')}</span></div>
                        <div style="margin-top:8px;font-size:11px;color:#F85149;font-weight:600">‚ö† INTERCEPT REQUIRED</div>
                      </div>`);
                m.addTo(map);
                state.markers['tv_' + v.id] = m;
            });

            // Plot active incidents
            state.incidents.filter(i => i.status === 'ACTIVE').forEach(inc => {
                const c = COLORS[inc.type] || COLORS.DEFAULT;
                const m = L.marker([inc.latitude, inc.longitude], { icon: makeIcon(c, 16) })
                    .bindPopup(`<b style="color:${c}">${inc.type.replace(/_/g, ' ')}</b><br><span style="font-size:11px;color:#8B949E">Camera: ${inc.camera_id}</span><br><br><button onclick="clearIncident('${inc.id}')" style="background:#238636;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer">Clear Incident</button>`);
                m.addTo(map);
                state.markers['inc_' + inc.id] = m;
            });

            // Plot officers with badge icons
            const officersToShow = state.officers.length > 0 ? state.officers : DEMO_OFFICERS;
            officersToShow.forEach(o => {
                const m = L.marker([o.latitude, o.longitude], { icon: makeOfficerIcon(o.on_duty, o.heading || 0) })
                    .bindPopup(`
                      <div style="background:#161B22;color:#C9D1D9;padding:10px;border-radius:6px;min-width:190px">
                        <b style="color:${o.on_duty ? '#58A6FF' : '#8B949E'}">üöî Officer ${o.officer_id}</b>
                        <div style="font-size:11px;color:#8B949E;margin-top:4px">Status: <span style="color:${o.on_duty ? '#3FB950' : '#F85149'}">${o.on_duty ? 'ON DUTY' : 'OFF DUTY'}</span></div>
                        <div style="font-size:11px;color:#8B949E">Speed: ${Math.round((o.speed_mps || 0) * 3.6)} km/h</div>
                        <div style="font-size:11px;color:#8B949E">Heading: ${o.heading || 0}¬∞</div>
                      </div>`);
                m.addTo(map);
                state.markers['off_' + o.officer_id] = m;
            });
        }

        // WebSocket logic
        function connectWS() {
            const badge = document.getElementById('ws-badge');
            const ws = new WebSocket(`ws://${location.hostname || 'localhost'}:8000/ws/control/web-${Math.floor(Math.random() * 1000)}`);

            ws.onopen = () => {
                badge.style.color = '#3FB950'; badge.style.borderColor = '#3FB95044'; badge.style.backgroundColor = '#3FB95011';
                badge.innerHTML = '<div class="dot" style="background:#3FB950; animation: pulse 2s infinite"></div> CONNECTED';
            };

            ws.onmessage = (e) => {
                const data = JSON.parse(e.data);
                if (data.type === 'INCIDENT_DETECTED') {
                    state.incidents.unshift(data);
                    if (state.incidents.length > 100) state.incidents.pop();
                } else if (data.type === 'INCIDENT_CLEARED') {
                    const inc = state.incidents.find(i => i.id === data.incident_id);
                    if (inc) inc.status = 'CLEARED';
                } else if (data.type === 'CRITICAL_VEHICLE_DETECTED') {
                    state.criticalAlerts.unshift(data);
                    if (state.criticalAlerts.length > 30) state.criticalAlerts.pop();
                } else if (data.type === 'INTERCEPT_ALERT') {
                    state.interceptAlerts.unshift(data);
                    if (state.interceptAlerts.length > 30) state.interceptAlerts.pop();
                } else if (data.type === 'OFFICER_LOCATION_UPDATE') {
                    const idx = state.officers.findIndex(o => o.officer_id === data.officer_id);
                    if (idx >= 0) {
                        state.officers[idx] = data;
                    } else {
                        state.officers.push(data);
                    }
                }
                updateUI();
            };

            ws.onclose = () => {
                badge.style.color = '#F85149'; badge.style.borderColor = '#F8514944'; badge.style.backgroundColor = '#F8514911';
                badge.innerHTML = '<div class="dot" style="background:#F85149"></div> DISCONNECTED';
                setTimeout(connectWS, 3000);
            };
        }

        // Initial load
        Promise.all([
            fetch(`${API}/api/v1/incidents?limit=50`).then(r => r.json()),
            fetch(`${API}/api/v1/officers`).then(r => r.json()).catch(() => [])
        ]).then(([incData, offData]) => {
            state.incidents = incData;
            state.officers = (Array.isArray(offData) && offData.length > 0) ? offData : DEMO_OFFICERS;
            updateUI();
            connectWS();
        }).catch(() => {
            state.officers = DEMO_OFFICERS;
            updateUI();
            connectWS();
        });

    </script>
</body>

</html>