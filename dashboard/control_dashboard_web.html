<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Athena ‚Äî Control Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: #0D1117;
            color: #C9D1D9;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            display: flex;
            align-items: center;
            padding: 12px 24px;
            background: #161B22;
            border-bottom: 1px solid #21262D;
        }

        .brand {
            font-size: 20px;
            font-weight: 800;
            color: #58A6FF;
            letter-spacing: 2px;
        }

        .stats {
            margin-left: auto;
            display: flex;
            gap: 24px;
        }

        .stat {
            text-align: center;
        }

        .stat-val {
            font-size: 20px;
            font-weight: 700;
        }

        .stat-lbl {
            font-size: 10px;
            color: #8B949E;
            text-transform: uppercase;
        }

        .main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        #map {
            flex: 1;
            background: #161B22;
        }

        .panel {
            width: 380px;
            background: #161B22;
            border-left: 1px solid #21262D;
            display: flex;
            flex-direction: column;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #21262D;
        }

        .tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            color: #8B949E;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
        }

        .tab.active {
            color: #E6EDF3;
            border-bottom-color: #58A6FF;
        }

        .tab span {
            background: #21262D;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 6px;
        }

        .list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .card {
            background: #0D1117;
            border: 1px solid #21262D;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
        }

        .card-title {
            font-size: 11px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
            margin-bottom: 6px;
        }

        .card-meta {
            font-size: 11px;
            color: #8B949E;
            margin-top: 4px;
        }

        .card-main {
            font-size: 14px;
            font-weight: 600;
            color: #E6EDF3;
            margin: 4px 0;
        }

        .btn-clear {
            background: #238636;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
            float: right;
            font-weight: 600;
        }

        .btn-clear:hover {
            background: #2EA043;
        }

        .ws-badge {
            font-size: 10px;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .popup-custom {
            background: #161B22;
            color: #C9D1D9;
            border-radius: 6px;
            padding: 8px;
            border: 1px solid #30363D;
            width: 160px;
        }

        .leaflet-popup-content-wrapper,
        .leaflet-popup-tip {
            background: #161B22;
            color: #C9D1D9;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.4; }
            100% { opacity: 1; }
        }

        /* Skeleton loaders */
        .skeleton-card {
            background: #161B22;
            border: 1px solid #21262D;
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 8px;
            overflow: hidden;
        }
        .skeleton-line {
            height: 12px;
            border-radius: 4px;
            background: linear-gradient(90deg, #21262D 25%, #30363D 50%, #21262D 75%);
            background-size: 200% 100%;
            animation: shimmer 1.4s infinite;
            margin-bottom: 8px;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* WS disconnection banner */
        #ws-banner {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0;
            background: #F85149;
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 13px;
            font-weight: 600;
            z-index: 9998;
        }
    </style>
</head>

<body>

    <div id="ws-banner">‚ö† Live connection lost ‚Äî reconnecting...</div>

    <header>
        <div style="display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 24px;">üèõÔ∏è</span>
            <div>
                <div class="brand">ATHENA</div>
                <div style="font-size: 11px; color: #8B949E;">Control Dashboard</div>
            </div>
            <select id="city-select" onchange="changeCity(this.value)" style="
                background: #0D1117; color: #E6EDF3; border: 1px solid #30363D;
                border-radius: 6px; padding: 6px 12px; font-size: 12px; font-weight: 600;
                cursor: pointer; margin-left: 8px;">
            </select>
        </div>
        <div class="stats">
            <div class="stat">
                <div class="stat-val" style="color: #F85149" id="s-inc">0</div>
                <div class="stat-lbl">Incidents</div>
            </div>
            <div class="stat">
                <div class="stat-val" style="color: #FF7B72" id="s-crit">0</div>
                <div class="stat-lbl">Critical</div>
            </div>
            <div class="stat">
                <div class="stat-val" style="color: #58A6FF" id="s-int">0</div>
                <div class="stat-lbl">Intercept</div>
            </div>
            <div style="display: flex; align-items: center;">
                <div class="ws-badge" id="ws-badge"
                    style="color: #E3B341; border-color: #E3B34144; background: #E3B34111;">
                    <div class="dot" style="background: #E3B341"></div> CONNECTING
                </div>
            </div>
        </div>
    </header>

    <div class="main">
        <div id="map"></div>
        <div class="panel">
            <div class="tabs">
                <button class="tab active" onclick="setTab('incidents')">üö¶ Incidents <span id="t-inc">0</span></button>
                <button class="tab" onclick="setTab('critical')">üö® Critical <span id="t-crit">0</span></button>
                <button class="tab" onclick="setTab('intercept')">‚ö° Intercept <span id="t-int">0</span></button>
            </div>
            <div class="list" id="list"></div>
        </div>
    </div>

    <div id="toast-container" style="position:fixed;bottom:20px;right:20px;display:flex;flex-direction:column;gap:8px;z-index:9999;pointer-events:none;"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API = location.hostname === '' ? 'http://localhost:8000' : `${location.protocol}//${location.hostname}:8000`;

        // ‚îÄ‚îÄ Indian Cities ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const CITIES = {
            'Bangalore':  { lat: 12.9716, lng: 77.5946, cameras: ['CAM-MG-ROAD', 'CAM-INDIRANAGAR', 'CAM-KORAMANGALA', 'CAM-WHITEFIELD', 'CAM-JAYANAGAR'] },
            'Mumbai':     { lat: 19.0760, lng: 72.8777, cameras: ['CAM-MARINE-DRIVE', 'CAM-BANDRA', 'CAM-ANDHERI', 'CAM-KURLA', 'CAM-COLABA'] },
            'Delhi':      { lat: 28.6139, lng: 77.2090, cameras: ['CAM-CP', 'CAM-KAROL-BAGH', 'CAM-LAJPAT-NAGAR', 'CAM-ROHINI', 'CAM-DWARKA'] },
            'Chennai':    { lat: 13.0827, lng: 80.2707, cameras: ['CAM-ANNA-NAGAR', 'CAM-T-NAGAR', 'CAM-ADYAR', 'CAM-VELACHERY', 'CAM-PORUR'] },
            'Hyderabad':  { lat: 17.3850, lng: 78.4867, cameras: ['CAM-HITECH-CITY', 'CAM-BANJARA-HILLS', 'CAM-SECUNDERABAD', 'CAM-LB-NAGAR', 'CAM-KUKATPALLY'] },
            'Kolkata':    { lat: 22.5726, lng: 88.3639, cameras: ['CAM-PARK-STREET', 'CAM-HOWRAH', 'CAM-SALT-LAKE', 'CAM-ESPLANADE', 'CAM-NEW-TOWN'] },
            'Pune':       { lat: 18.5204, lng: 73.8567, cameras: ['CAM-KOREGAON-PARK', 'CAM-HINJEWADI', 'CAM-SHIVAJINAGAR', 'CAM-KOTHRUD', 'CAM-HADAPSAR'] },
            'Ahmedabad':  { lat: 23.0225, lng: 72.5714, cameras: ['CAM-SG-HIGHWAY', 'CAM-CG-ROAD', 'CAM-NAVRANGPURA', 'CAM-BODAKDEV', 'CAM-MANINAGAR'] },
            'Jaipur':     { lat: 26.9124, lng: 75.7873, cameras: ['CAM-MI-ROAD', 'CAM-VAISHALI-NAGAR', 'CAM-MALVIYA-NAGAR', 'CAM-TONK-ROAD', 'CAM-MANSAROVAR'] },
            'Kochi':      { lat:  9.9312, lng: 76.2673, cameras: ['CAM-MG-ROAD-KOCHI', 'CAM-EDAPPALLY', 'CAM-KAKKANAD', 'CAM-FORT-KOCHI', 'CAM-ALUVA'] },
        };
        let selectedCity = 'Bangalore';

        // State
        const state = {
            incidents: [],
            criticalAlerts: [],
            interceptAlerts: [],
            officers: [],
            tab: 'incidents',
            markers: {} // id -> leaflet marker
        };

        // Colors
        const COLORS = {
            STALLED_VEHICLE: '#F0883E',
            BREAKDOWN: '#E3B341',
            ACCIDENT: '#F85149',
            PEDESTRIAN_VIOLATION: '#BC8CFF',
            KIDNAPPING: '#F85149',
            HIT_AND_RUN: '#FF7B72',
            STOLEN: '#E3B341',
            DEFAULT: '#58A6FF'
        };

        // Init Map
        const map = L.map('map', { zoomControl: false }).setView([20.5937, 78.9629], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        function makeIcon(color, size = 14) {
            return L.divIcon({
                className: '',
                html: `<div style="width:${size}px;height:${size}px;background:${color};border:2px solid #fff;border-radius:50%;box-shadow:0 0 10px ${color}"></div>`,
                iconSize: [size, size],
                iconAnchor: [size / 2, size / 2]
            });
        }

        // Render logic
        function updateUI() {
            const activeInc = state.incidents.filter(i => i.status === 'ACTIVE');
            document.getElementById('s-inc').innerText = activeInc.length;
            document.getElementById('t-inc').innerText = activeInc.length;
            document.getElementById('s-crit').innerText = state.criticalAlerts.length;
            document.getElementById('t-crit').innerText = state.criticalAlerts.length;
            document.getElementById('s-int').innerText = state.interceptAlerts.length;
            document.getElementById('t-int').innerText = state.interceptAlerts.length;

            renderList();
            renderMarkers();
        }

        function setTab(name) {
            state.tab = name;
            document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
            renderList();
        }

        function timeStr(iso) {
            if (!iso) return '';
            return new Date(iso).toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        function clearIncident(id) {
            fetch(`${API}/api/v1/incidents/${id}/clear`, { method: 'POST' })
                .then(() => {
                    const inc = state.incidents.find(i => i.id === id);
                    if (inc) { inc.status = 'CLEARED'; updateUI(); }
                });
        }

        function renderList() {
            const list = document.getElementById('list');
            list.innerHTML = '';

            if (state.tab === 'incidents') {
                state.incidents.forEach(inc => {
                    const c = COLORS[inc.type] || COLORS.DEFAULT;
                    const isActive = inc.status === 'ACTIVE';
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.borderColor = isActive ? c + '66' : '#21262D';
                    card.innerHTML = `
            ${isActive ? `<button class="btn-clear" onclick="clearIncident('${inc.id}')">CLEAR</button>` : ''}
            <div class="card-title" style="color:${c}; background:${c}22">${inc.type.replace(/_/g, ' ')}</div>
            <div class="card-meta">üìç ${inc.latitude.toFixed(4)}, ${inc.longitude.toFixed(4)}</div>
            <div class="card-meta">üì∑ ${inc.camera_id} ¬∑ ${(inc.confidence * 100).toFixed(0)}% conf</div>
            <div class="card-meta" style="color:${isActive ? '#3FB950' : '#8B949E'}; margin-top:8px; display:flex; justify-content:space-between">
              <span>${inc.status}</span>
              <span>${timeStr(inc.detected_at)}</span>
            </div>
          `;
                    list.appendChild(card);
                });
            } else if (state.tab === 'critical') {
                state.criticalAlerts.forEach(c => {
                    const col = COLORS[c.case_type] || COLORS.DEFAULT;
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.borderColor = col + '66';
                    card.innerHTML = `
            <div style="float:right; font-size:10px; color:${col}; background:${col}22; padding:2px 6px; border-radius:10px;">${c.priority}</div>
            <div class="card-title" style="color:${col}; background:${col}22">üö® ${c.case_type.replace(/_/g, ' ')}</div>
            <div class="card-main">${c.license_plate}</div>
            <div class="card-meta">${c.make} ${c.model}</div>
            <div class="card-meta">Case: ${c.case_number}</div>
            <div class="card-meta" style="margin-top:8px">${timeStr(c.timestamp)}</div>
          `;
                    list.appendChild(card);
                });
            } else if (state.tab === 'intercept') {
                state.interceptAlerts.forEach(a => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.borderColor = '#58A6FF66';
                    card.innerHTML = `
            <div style="float:right; text-align:right;">
              <div style="color:#58A6FF; font-size:16px; font-weight:700">${Math.round(a.distance_m)}m</div>
              <div class="card-meta">${a.direction} ¬∑ ETA ${Math.round(a.estimated_intercept_s)}s</div>
            </div>
            <div class="card-title" style="color:#58A6FF; background:#58A6FF22">‚ö° INTERCEPT</div>
            <div class="card-main">${a.vehicle_plate}</div>
            <div class="card-meta">${a.vehicle_make} ${a.vehicle_model}</div>
            <div class="card-meta" style="color:#E3B341; margin-top:4px">${a.violation_type.replace(/_/g, ' ')}</div>
          `;
                    list.appendChild(card);
                });
            }
        }

        function renderMarkers() {
            // Clear all
            Object.values(state.markers).forEach(m => map.removeLayer(m));
            state.markers = {};

            const toRender = [];

            // Plot active incidents
            state.incidents.filter(i => i.status === 'ACTIVE').forEach(inc => {
                const c = COLORS[inc.type] || COLORS.DEFAULT;
                const m = L.marker([inc.latitude, inc.longitude], { icon: makeIcon(c, 16) })
                    .bindPopup(`<b style="color:${c}">${inc.type.replace(/_/g, ' ')}</b><br><span style="font-size:11px;color:#8B949E">Camera: ${inc.camera_id}</span><br><br><button onclick="clearIncident('${inc.id}')" style="background:#238636;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer">Clear Incident</button>`);
                m.addTo(map);
                state.markers['inc_' + inc.id] = m;
                toRender.push([inc.latitude, inc.longitude]);
            });

            // Plot criticals
            state.criticalAlerts.forEach(a => {
                const c = COLORS[a.case_type] || COLORS.DEFAULT;
                const m = L.marker([a.location.latitude, a.location.longitude], { icon: makeIcon(c, 20) })
                    .bindPopup(`<b>üö® ${a.case_type}</b><br>${a.license_plate}<br><span style="font-size:11px;color:#8B949E">Case: ${a.case_number}</span>`);
                m.addTo(map);
                state.markers['crit_' + a.vehicle_id] = m;
                toRender.push([a.location.latitude, a.location.longitude]);
            });

            // Plot officers
            state.officers.forEach(o => {
                const m = L.marker([o.latitude, o.longitude], { icon: makeIcon('#58A6FF', 16) })
                    .bindPopup(`<b>üöî Officer ${o.officer_id}</b><br><span style="font-size:11px;color:#8B949E">Speed: ${Math.round(o.speed_mps * 3.6)} km/h</span>`);
                m.addTo(map);
                state.markers['off_' + o.officer_id] = m;
                toRender.push([o.latitude, o.longitude]);
            });

            // Auto-fit bounds if we have points
            if (toRender.length > 0) {
                map.fitBounds(L.latLngBounds(toRender), { padding: [50, 50], maxZoom: 15 });
            }
        }

        // City selector
        function changeCity(name) {
            selectedCity = name;
            const c = CITIES[name];
            map.setView([c.lat, c.lng], 13, { animate: true });
            state.incidents = []; state.criticalAlerts = []; state.interceptAlerts = [];
            updateUI();
            fetch(`${API}/api/v1/incidents?limit=50&city=${encodeURIComponent(name)}`)
                .then(r => r.json())
                .then(data => { state.incidents = data; updateUI(); });
        }

        // Toast notifications
        function showToast(message, color = '#58A6FF') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.style.cssText = `
                background: #161B22; border: 1px solid ${color}44;
                color: #E6EDF3; padding: 10px 16px; border-radius: 8px;
                font-size: 13px; font-weight: 500; pointer-events: auto;
                box-shadow: 0 4px 12px rgba(0,0,0,0.4);
                border-left: 3px solid ${color};
                transition: opacity 0.3s; opacity: 1; max-width: 280px;
            `;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 4000);
            while (container.children.length > 3) container.firstChild.remove();
        }

        // WebSocket logic
        function connectWS() {
            const badge = document.getElementById('ws-badge');
            const banner = document.getElementById('ws-banner');
            const ws = new WebSocket(`ws://${location.hostname || 'localhost'}:8000/ws/control/web-${Math.floor(Math.random() * 1000)}`);

            ws.onopen = () => {
                badge.style.color = '#3FB950'; badge.style.borderColor = '#3FB95044'; badge.style.backgroundColor = '#3FB95011';
                badge.innerHTML = '<div class="dot" style="background:#3FB950; animation: pulse 2s infinite"></div> CONNECTED';
                banner.style.display = 'none';
            };

            ws.onmessage = (e) => {
                const data = JSON.parse(e.data);
                if (data.type === 'INCIDENT_DETECTED') {
                    const city = data.data?.city;
                    if (!city || city === selectedCity) {
                        state.incidents.unshift(data);
                        if (state.incidents.length > 100) state.incidents.pop();
                        showToast('üî¥ New incident: ' + (data.data?.type || '').replace(/_/g, ' '), '#F85149');
                    }
                } else if (data.type === 'INCIDENT_CLEARED') {
                    const inc = state.incidents.find(i => i.id === data.incident_id);
                    if (inc) inc.status = 'CLEARED';
                    showToast('‚úÖ Incident cleared', '#3FB950');
                } else if (data.type === 'CRITICAL_VEHICLE_DETECTED') {
                    state.criticalAlerts.unshift(data);
                    if (state.criticalAlerts.length > 30) state.criticalAlerts.pop();
                    showToast('üö® Critical vehicle: ' + (data.data?.license_plate || ''), '#FF7B72');
                } else if (data.type === 'INTERCEPT_ALERT') {
                    state.interceptAlerts.unshift(data);
                    if (state.interceptAlerts.length > 30) state.interceptAlerts.pop();
                    showToast('‚ö° Intercept alert issued', '#58A6FF');
                } else if (data.type === 'OFFICER_LOCATION_UPDATE') {
                    const idx = state.officers.findIndex(o => o.officer_id === data.officer_id);
                    if (idx >= 0) {
                        state.officers[idx] = data;
                    } else {
                        state.officers.push(data);
                    }
                }
                updateUI();
            };

            ws.onclose = () => {
                badge.style.color = '#F85149'; badge.style.borderColor = '#F8514944'; badge.style.backgroundColor = '#F8514911';
                badge.innerHTML = '<div class="dot" style="background:#F85149"></div> DISCONNECTED';
                banner.style.display = 'block';
                setTimeout(connectWS, 3000);
            };

            ws.onerror = () => {
                banner.style.display = 'block';
            };
        }

        // Skeleton loader
        function showSkeleton() {
            const list = document.getElementById('list');
            list.innerHTML = [1, 2, 3].map(() => `
                <div class="skeleton-card">
                    <div class="skeleton-line" style="width:40%"></div>
                    <div class="skeleton-line" style="width:70%"></div>
                    <div class="skeleton-line" style="width:55%"></div>
                </div>
            `).join('');
        }

        // Populate city dropdown and set initial map view
        (function initCities() {
            const sel = document.getElementById('city-select');
            Object.keys(CITIES).forEach(name => {
                const opt = document.createElement('option');
                opt.value = name; opt.text = name;
                if (name === selectedCity) opt.selected = true;
                sel.appendChild(opt);
            });
            map.setView([CITIES[selectedCity].lat, CITIES[selectedCity].lng], 13);
        })();

        // Initial load
        showSkeleton();
        Promise.all([
            fetch(`${API}/api/v1/incidents?limit=50&city=${encodeURIComponent(selectedCity)}`).then(r => r.json()),
            fetch(`${API}/api/v1/officers`).then(r => r.json()).catch(() => [])
        ]).then(([incData, offData]) => {
            state.incidents = incData;
            state.officers = offData;
            updateUI();
            connectWS();
        });

    </script>
</body>

</html>